name: build-on-sgx

on:
  push:
    branches: [ "quote-presentation" ]
  pull_request:
    branches: [ "quote-presentation" ]
    
concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-on-sgx:
    environment: tee
    runs-on: [self-hosted, linux]
    env:
      EVENTTAG: ${{ github.event.pull_request.head.sha || github.sha }}
    container:
      image: notaryserverbuilds.azurecr.io/builder/gramine
      credentials:
        username: notaryserverbuilds
        password: ${{ secrets.AZURE_CR_BUILDS_PW }}
      ports: 
        - "7047:7047"
      env:
        TAG: $EVENTTAG
      options: "--device /dev/sgx_enclave"
    steps:
       - uses: actions/checkout@v3
       - uses: actions-rs/toolchain@v1
         with:
            profile: minimal
            toolchain: nightly
       - uses: actions-rs/cargo@v1
         with:
            command: run
            # : default: notary-server config file needs to be in `pwd`/config/config.yaml  X_X
            args: --release --features tee_quote --bin notary-server  --manifest-path crates/notary/server/Cargo.toml --target-dir crates/notary/server/Cargo.toml 
       - uses: actions-rs/audit-check@v1
         with:
            token: ${{ secrets.PAT_SET_ENV }}

