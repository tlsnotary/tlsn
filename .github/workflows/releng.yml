name: Publish tlsn-wasm to NPM

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to publish to NPM'
        required: true
        default: 'v0.1.0-alpha.9'

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Find workflow run ID
        id: find_run
        run: |
          RUN_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/tlsnotary/tlsn/actions/workflows/ci.yml/runs \
            --jq '.workflow_runs[] | select(.head_branch == "${{ github.event.inputs.tag }}") | .id')

          if [ -z "$RUN_ID" ]; then
            echo "No run found for tag ${{ github.event.inputs.tag }}"
            exit 1
          fi

          echo "Found run: $RUN_ID"
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.find_run.outputs.run_id }}
          # name: ${{ github.event.inputs.tag }}-tlsn-wasm-pkg
          path: tlsn-wasm-pkg

      - name: NPM Publish for tlsn-wasm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd tlsn-wasm-pkg
          # FIXME: remove dry-run before merging
          npm publish --dry-run
